<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RetroTUI Preview</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #000;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    font-family: 'Courier New', 'Consolas', monospace;
  }
  .terminal {
    background: #008080;
    width: 820px;
    height: 520px;
    position: relative;
    overflow: hidden;
    border: 2px solid #444;
    box-shadow: 0 0 30px rgba(0,128,128,0.3);
    font-size: 13px;
    line-height: 1.3;
  }
  /* Desktop pattern */
  .desktop {
    position: absolute;
    top: 22px;
    left: 0;
    right: 0;
    bottom: 22px;
    color: #006666;
    font-size: 12px;
    overflow: hidden;
    user-select: none;
    letter-spacing: 1px;
  }
  /* Menu bar */
  .menubar {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 22px;
    background: #c0c0c0;
    color: #000;
    display: flex;
    align-items: center;
    padding: 0 4px;
    border-bottom: 1px solid #808080;
    z-index: 100;
  }
  .menu-item {
    padding: 2px 10px;
    cursor: pointer;
    font-size: 13px;
  }
  .menu-item:hover, .menu-item.active {
    background: #000080;
    color: #fff;
  }
  .menu-hamburger {
    font-weight: bold;
    padding: 2px 8px;
    font-size: 14px;
  }
  .clock {
    margin-left: auto;
    padding: 2px 8px;
    font-size: 12px;
    color: #333;
  }
  /* Dropdown */
  .dropdown {
    position: absolute;
    top: 22px;
    background: #c0c0c0;
    border: 1px solid #808080;
    box-shadow: 2px 2px 0 #000;
    z-index: 200;
    display: none;
    min-width: 180px;
  }
  .dropdown.show { display: block; }
  .dropdown-item {
    padding: 3px 16px;
    cursor: pointer;
    font-size: 13px;
    white-space: nowrap;
  }
  .dropdown-item:hover {
    background: #000080;
    color: #fff;
  }
  .dropdown-sep {
    border-top: 1px solid #808080;
    margin: 2px 4px;
  }
  /* Status bar */
  .statusbar {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 22px;
    background: #008080;
    color: #fff;
    display: flex;
    align-items: center;
    padding: 0 8px;
    font-size: 12px;
    border-top: 1px solid #006060;
  }
  /* Icons */
  .icon {
    position: absolute;
    width: 64px;
    text-align: center;
    cursor: pointer;
    padding: 4px;
    border: 1px solid transparent;
    user-select: none;
  }
  .icon:hover, .icon.selected {
    background: rgba(0,0,128,0.3);
    border-color: rgba(255,255,255,0.3);
  }
  .icon-sym {
    font-size: 24px;
    display: block;
    margin-bottom: 2px;
  }
  .icon-label {
    font-size: 11px;
    color: #fff;
    text-shadow: 1px 1px 0 #000;
  }
  /* Window */
  .window {
    position: absolute;
    background: #c0c0c0;
    border: 2px solid #fff;
    border-right-color: #000;
    border-bottom-color: #000;
    box-shadow: 1px 1px 0 #000;
    min-width: 200px;
    min-height: 100px;
  }
  .win-titlebar {
    background: #000080;
    color: #fff;
    padding: 2px 4px;
    font-size: 13px;
    font-weight: bold;
    display: flex;
    align-items: center;
    cursor: move;
    user-select: none;
  }
  .win-titlebar.inactive {
    background: #808080;
  }
  .win-title { flex: 1; }
  .win-close {
    background: #c0c0c0;
    color: #000;
    border: 1px solid #000;
    border-top-color: #fff;
    border-left-color: #fff;
    width: 18px;
    height: 16px;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }
  .win-close:hover { background: #ff0000; color: #fff; }
  .win-close:active {
    border-color: #000;
    border-bottom-color: #fff;
    border-right-color: #fff;
  }
  .win-body {
    padding: 8px;
    background: #fff;
    color: #000;
    font-size: 12px;
    margin: 2px;
    min-height: 60px;
    max-height: 300px;
    overflow-y: auto;
    line-height: 1.5;
  }
  .win-body pre {
    margin: 0;
    font-family: inherit;
    white-space: pre-wrap;
  }
  /* Dialog overlay */
  .dialog-overlay {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.2);
    z-index: 300;
    display: none;
    justify-content: center;
    align-items: center;
  }
  .dialog-overlay.show { display: flex; }
  .dialog {
    background: #c0c0c0;
    border: 2px solid #fff;
    border-right-color: #000;
    border-bottom-color: #000;
    padding: 0;
    min-width: 300px;
    box-shadow: 3px 3px 0 rgba(0,0,0,0.5);
  }
  .dialog .win-titlebar { cursor: default; }
  .dialog-body {
    padding: 16px 20px;
    font-size: 13px;
    line-height: 1.6;
  }
  .dialog-buttons {
    padding: 8px 20px 16px;
    text-align: center;
  }
  .btn {
    background: #c0c0c0;
    border: 2px solid #fff;
    border-right-color: #000;
    border-bottom-color: #000;
    padding: 4px 20px;
    font-family: inherit;
    font-size: 13px;
    cursor: pointer;
    margin: 0 4px;
  }
  .btn:active {
    border-color: #000;
    border-bottom-color: #fff;
    border-right-color: #fff;
  }
  .btn:hover { background: #d0d0d0; }
  .btn.primary {
    outline: 1px dotted #000;
    outline-offset: -4px;
  }
  /* File Manager specific */
  .fm-pathbar {
    color: #000;
    font-weight: bold;
    border-bottom: 1px solid #808080;
    padding: 2px 0 4px 0;
    margin-bottom: 4px;
  }
  .fm-entry {
    padding: 1px 4px;
    cursor: pointer;
    white-space: nowrap;
  }
  .fm-entry:hover {
    background: #000080;
    color: #fff;
  }
  .fm-entry.selected {
    background: #000080;
    color: #fff;
  }
  .fm-separator {
    color: #808080;
    user-select: none;
  }
  .fm-statusline {
    border-top: 1px solid #808080;
    padding-top: 4px;
    margin-top: 4px;
    font-size: 11px;
    color: #666;
  }

  @media (max-width: 850px) {
    .terminal { width: 100%; height: 100vh; border: none; }
  }
</style>
</head>
<body>
<div class="terminal" id="terminal">
  <!-- Menu Bar -->
  <div class="menubar">
    <span class="menu-hamburger">â‰¡</span>
    <span class="menu-item" data-menu="file">File</span>
    <span class="menu-item" data-menu="edit">Edit</span>
    <span class="menu-item" data-menu="help">Help</span>
    <span class="clock" id="clock">00:00:00</span>
  </div>

  <!-- Dropdowns -->
  <div class="dropdown" id="dd-file" style="left:30px">
    <div class="dropdown-item" data-action="new">New Window</div>
    <div class="dropdown-item" data-action="filemanager">File Manager</div>
    <div class="dropdown-item" data-action="terminal">Terminal</div>
    <div class="dropdown-sep"></div>
    <div class="dropdown-item" data-action="exit">Exit  Ctrl+Q</div>
  </div>
  <div class="dropdown" id="dd-edit" style="left:80px">
    <div class="dropdown-item" data-action="settings">Preferences</div>
  </div>
  <div class="dropdown" id="dd-help" style="left:130px">
    <div class="dropdown-item" data-action="about">About RetroTUI</div>
    <div class="dropdown-item" data-action="help">Keyboard Help</div>
  </div>

  <!-- Desktop -->
  <div class="desktop" id="desktop"></div>

  <!-- Icons -->
  <div class="icon" style="left:10px;top:40px" data-action="filemanager" ondblclick="doAction('filemanager')">
    <span class="icon-sym">ğŸ“</span>
    <span class="icon-label">Files</span>
  </div>
  <div class="icon" style="left:10px;top:110px" data-action="notepad" ondblclick="doAction('notepad')">
    <span class="icon-sym">ğŸ“</span>
    <span class="icon-label">Notepad</span>
  </div>
  <div class="icon" style="left:10px;top:180px" data-action="terminal" ondblclick="doAction('terminal')">
    <span class="icon-sym">ğŸ’»</span>
    <span class="icon-label">Terminal</span>
  </div>
  <div class="icon" style="left:10px;top:250px" data-action="settings" ondblclick="doAction('settings')">
    <span class="icon-sym">âš™ï¸</span>
    <span class="icon-label">Settings</span>
  </div>
  <div class="icon" style="left:10px;top:320px" data-action="about" ondblclick="doAction('about')">
    <span class="icon-sym">â„¹ï¸</span>
    <span class="icon-label">About</span>
  </div>

  <!-- Status Bar -->
  <div class="statusbar" id="statusbar">
    RetroTUI v0.2.2 â”‚ Windows: <span id="win-count">0</span> â”‚ Mouse: Enabled â”‚ Double-click icons to open
  </div>

  <!-- Dialog Overlay -->
  <div class="dialog-overlay" id="dialog-overlay">
    <div class="dialog" id="dialog">
      <div class="win-titlebar">
        <span class="win-title" id="dlg-title">Dialog</span>
      </div>
      <div class="dialog-body" id="dlg-body"></div>
      <div class="dialog-buttons" id="dlg-buttons"></div>
    </div>
  </div>
</div>

<script>
// State
let windows = [];
let winIdCounter = 0;
let activeDropdown = null;
let dragState = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Mock Filesystem for File Manager
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const mockFS = {
  '/home/user': {
    dirs: ['Documents', 'Downloads', 'Pictures', 'Music', '.config'],
    files: [
      { name: 'readme.txt', size: '2.4K', content: 'Welcome to RetroTUI!\n\nThis is a sample text file.\nYou can browse files and open them\nin the built-in Notepad viewer.\n\nFeatures:\n  - Directory navigation\n  - File viewer\n  - Keyboard & mouse support' },
      { name: 'config.json', size: '512B', content: '{\n  "theme": "win31",\n  "show_hidden": false,\n  "colors": 256,\n  "desktop_pattern": "â–‘"\n}' },
      { name: 'retrotui.py', size: '28.5K', content: '#!/usr/bin/env python3\n"""RetroTUI v0.2"""\nimport curses\nimport time\nimport os\n\n# ... (28.5K of Python code)\n# Full source at github.com/roccolate/RetroTUI' },
      { name: 'setup.sh', size: '1.8K', content: '#!/bin/bash\n# RetroTUI Setup\necho "Installing..."\nsudo apt install gpm\necho "Done!"' },
    ]
  },
  '/home/user/Documents': {
    dirs: ['Projects', 'Notes'],
    files: [
      { name: 'todo.txt', size: '512B', content: 'TODO List:\n\n[x] File Manager navigation\n[x] File viewer (Notepad)\n[ ] Text editor\n[ ] Terminal emulator\n[ ] Theme engine' },
      { name: 'report.pdf', size: '1.2M', content: null },
      { name: 'ideas.txt', size: '256B', content: 'Ideas for RetroTUI:\n\n- Add Win95 theme\n- Minesweeper game\n- Calculator app\n- Paint clone' },
    ]
  },
  '/home/user/Documents/Projects': {
    dirs: ['retrotui', 'dotfiles'],
    files: [
      { name: 'README.md', size: '3.1K', content: '# Projects\n\nThis folder contains various projects.\n\n## RetroTUI\nA retro desktop environment for Linux console.\n\n## Dotfiles\nConfiguration files backup.' },
    ]
  },
  '/home/user/Documents/Projects/retrotui': {
    dirs: [],
    files: [
      { name: 'retrotui.py', size: '28.5K', content: '#!/usr/bin/env python3\n"""RetroTUI v0.2"""\n# Main application source' },
      { name: 'preview.html', size: '12.4K', content: '<!DOCTYPE html>\n<!-- Interactive preview -->' },
      { name: 'PROJECT.md', size: '5.2K', content: '# RetroTUI Project Documentation\n\n## Architecture\n...' },
    ]
  },
  '/home/user/Documents/Projects/dotfiles': {
    dirs: [],
    files: [
      { name: '.bashrc', size: '2.1K', content: '# .bashrc\nexport PS1="\\u@\\h:\\w$ "\nalias ll="ls -la"\nalias retro="python3 ~/retrotui.py"' },
      { name: '.vimrc', size: '1.5K', content: '" .vimrc\nset number\nset tabstop=4\nsyntax on\ncolorscheme desert' },
    ]
  },
  '/home/user/Documents/Notes': {
    dirs: [],
    files: [
      { name: 'meeting.txt', size: '1.1K', content: 'Meeting Notes - 2024\n\n- Discuss RetroTUI roadmap\n- Review v0.2 features\n- Plan v0.3 text editor' },
      { name: 'shortcuts.txt', size: '384B', content: 'RetroTUI Shortcuts:\n\nTab      - Cycle windows\nCtrl+Q   - Exit\nF10      - Menu\nArrows   - Navigate\nEnter    - Open\nBackspace- Go up\nH        - Toggle hidden' },
    ]
  },
  '/home/user/Downloads': {
    dirs: [],
    files: [
      { name: 'archive.tar.gz', size: '4.5M', content: null },
      { name: 'image.png', size: '2.1M', content: null },
      { name: 'notes.txt', size: '128B', content: 'Downloaded files go here.' },
    ]
  },
  '/home/user/Pictures': {
    dirs: ['Screenshots', 'Wallpapers'],
    files: [
      { name: 'photo.jpg', size: '3.2M', content: null },
    ]
  },
  '/home/user/Pictures/Screenshots': {
    dirs: [],
    files: [
      { name: 'retrotui_v01.png', size: '156K', content: null },
      { name: 'retrotui_v02.png', size: '198K', content: null },
    ]
  },
  '/home/user/Pictures/Wallpapers': {
    dirs: [],
    files: [
      { name: 'teal_pattern.bmp', size: '768K', content: null },
    ]
  },
  '/home/user/Music': {
    dirs: [],
    files: [
      { name: 'startup.wav', size: '245K', content: null },
    ]
  },
  '/home/user/.config': {
    dirs: ['retrotui'],
    files: []
  },
  '/home/user/.config/retrotui': {
    dirs: [],
    files: [
      { name: 'config.json', size: '256B', content: '{\n  "theme": "win31",\n  "show_hidden": false\n}' },
      { name: 'themes.json', size: '1.2K', content: '{\n  "win31": {"desktop": "teal", "title": "navy"},\n  "dos": {"desktop": "black", "title": "gray"},\n  "win95": {"desktop": "teal", "title": "navy"}\n}' },
    ]
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Desktop pattern
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const desktop = document.getElementById('desktop');
function fillDesktop() {
  const cols = Math.ceil(desktop.clientWidth / 8);
  const rows = Math.ceil(desktop.clientHeight / 16);
  let html = '';
  for (let r = 0; r < rows; r++) {
    html += 'â–‘'.repeat(cols) + '\n';
  }
  desktop.textContent = html;
}
fillDesktop();
window.addEventListener('resize', fillDesktop);

// Clock
function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent =
    now.toLocaleTimeString('en-US', { hour12: false });
}
updateClock();
setInterval(updateClock, 1000);

// Menu dropdowns
document.querySelectorAll('.menu-item').forEach(item => {
  item.addEventListener('click', (e) => {
    e.stopPropagation();
    const menu = item.dataset.menu;
    const dd = document.getElementById('dd-' + menu);
    if (activeDropdown === dd) {
      closeDropdowns();
    } else {
      closeDropdowns();
      dd.classList.add('show');
      item.classList.add('active');
      activeDropdown = dd;
    }
  });
});

function closeDropdowns() {
  document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
  document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
  activeDropdown = null;
}

document.querySelectorAll('.dropdown-item').forEach(item => {
  item.addEventListener('click', () => {
    closeDropdowns();
    doAction(item.dataset.action);
  });
});

document.addEventListener('click', (e) => {
  if (!e.target.closest('.menubar') && !e.target.closest('.dropdown')) {
    closeDropdowns();
  }
});

// Window count
function updateWinCount() {
  document.getElementById('win-count').textContent = windows.length;
}

// Create window
function createWindow(title, content, x, y, w, h) {
  const id = winIdCounter++;
  const win = document.createElement('div');
  win.className = 'window';
  win.style.left = x + 'px';
  win.style.top = y + 'px';
  win.style.width = (w || 350) + 'px';
  win.dataset.id = id;

  win.innerHTML = `
    <div class="win-titlebar">
      <span class="win-title">${title}</span>
      <div class="win-close">Ã—</div>
    </div>
    <div class="win-body"><pre>${content}</pre></div>
  `;

  // Close button
  win.querySelector('.win-close').addEventListener('click', () => {
    win.remove();
    windows = windows.filter(w => w !== win);
    updateWinCount();
    if (windows.length > 0) activateWindow(windows[windows.length - 1]);
  });

  // Dragging
  const titlebar = win.querySelector('.win-titlebar');
  titlebar.addEventListener('mousedown', (e) => {
    if (e.target.classList.contains('win-close')) return;
    dragState = {
      win,
      offsetX: e.clientX - win.offsetLeft,
      offsetY: e.clientY - win.offsetTop
    };
    activateWindow(win);
    e.preventDefault();
  });

  // Focus on click
  win.addEventListener('mousedown', () => activateWindow(win));

  document.getElementById('terminal').appendChild(win);
  windows.push(win);
  activateWindow(win);
  updateWinCount();
  return win;
}

function activateWindow(win) {
  windows.forEach(w => {
    w.querySelector('.win-titlebar').classList.add('inactive');
    w.style.zIndex = 10;
  });
  win.querySelector('.win-titlebar').classList.remove('inactive');
  win.style.zIndex = 20;
}

// Dragging
document.addEventListener('mousemove', (e) => {
  if (!dragState) return;
  const term = document.getElementById('terminal');
  const rect = term.getBoundingClientRect();
  let x = e.clientX - dragState.offsetX;
  let y = e.clientY - dragState.offsetY;
  x = Math.max(0, Math.min(x, rect.width - 100));
  y = Math.max(22, Math.min(y, rect.height - 40));
  dragState.win.style.left = x + 'px';
  dragState.win.style.top = y + 'px';
});

document.addEventListener('mouseup', () => { dragState = null; });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// File Manager
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function createFileManager(startPath) {
  const offset = windows.length * 20;
  const id = winIdCounter++;
  const win = document.createElement('div');
  win.className = 'window';
  win.style.left = (100 + offset) + 'px';
  win.style.top = (50 + offset) + 'px';
  win.style.width = '420px';
  win.dataset.id = id;
  win.dataset.fmPath = startPath || '/home/user';
  win.dataset.fmSelected = '0';

  const path = win.dataset.fmPath;
  const basename = path.split('/').pop() || '/';
  const fsData = mockFS[path];
  const itemCount = fsData ? fsData.dirs.length + fsData.files.length : 0;

  win.innerHTML = `
    <div class="win-titlebar">
      <span class="win-title">File Manager - ${basename} (${itemCount} items)</span>
      <div class="win-close">Ã—</div>
    </div>
    <div class="win-body" style="padding:4px 8px">
      <div class="fm-content"></div>
    </div>
  `;

  // Close button
  win.querySelector('.win-close').addEventListener('click', () => {
    win.remove();
    windows = windows.filter(w => w !== win);
    updateWinCount();
    if (windows.length > 0) activateWindow(windows[windows.length - 1]);
  });

  // Dragging
  const titlebar = win.querySelector('.win-titlebar');
  titlebar.addEventListener('mousedown', (e) => {
    if (e.target.classList.contains('win-close')) return;
    dragState = {
      win,
      offsetX: e.clientX - win.offsetLeft,
      offsetY: e.clientY - win.offsetTop
    };
    activateWindow(win);
    e.preventDefault();
  });

  win.addEventListener('mousedown', () => activateWindow(win));

  document.getElementById('terminal').appendChild(win);
  windows.push(win);
  activateWindow(win);
  updateWinCount();

  renderFileManager(win);
  return win;
}

function renderFileManager(win) {
  const path = win.dataset.fmPath;
  const selectedIdx = parseInt(win.dataset.fmSelected) || 0;
  const fsData = mockFS[path];
  const container = win.querySelector('.fm-content');
  const basename = path.split('/').pop() || '/';

  if (!fsData) {
    container.innerHTML = `
      <div class="fm-pathbar">ğŸ“‚ ${path}</div>
      <div class="fm-separator">${'â”€'.repeat(50)}</div>
      <div style="padding:4px;color:#888">  â›” Path not found</div>
    `;
    return;
  }

  const entries = [];
  let html = `<div class="fm-pathbar">ğŸ“‚ ${path}</div>`;
  html += `<div class="fm-separator">${'â”€'.repeat(50)}</div>`;

  // Parent directory
  if (path !== '/home/user') {
    const parentPath = path.substring(0, path.lastIndexOf('/')) || '/home/user';
    entries.push({ name: '..', isDir: true, path: parentPath, content: null });
    const sel = entries.length - 1 === selectedIdx ? ' selected' : '';
    html += `<div class="fm-entry${sel}" data-idx="${entries.length - 1}" data-path="${parentPath}" data-type="dir">  ğŸ“ ..</div>`;
  }

  // Directories
  for (const dir of fsData.dirs) {
    const dirPath = path + '/' + dir;
    entries.push({ name: dir, isDir: true, path: dirPath, content: null });
    const sel = entries.length - 1 === selectedIdx ? ' selected' : '';
    html += `<div class="fm-entry${sel}" data-idx="${entries.length - 1}" data-path="${dirPath}" data-type="dir">  ğŸ“ ${dir}/</div>`;
  }

  // Files
  for (const file of fsData.files) {
    entries.push({ name: file.name, isDir: false, path: path + '/' + file.name, content: file.content, size: file.size });
    const sel = entries.length - 1 === selectedIdx ? ' selected' : '';
    const nameFormatted = file.name.length > 30 ? file.name.substring(0, 27) + '...' : file.name;
    html += `<div class="fm-entry${sel}" data-idx="${entries.length - 1}" data-path="${path + '/' + file.name}" data-type="file">  ğŸ“„ ${nameFormatted.padEnd(32)} ${file.size.padStart(8)}</div>`;
  }

  if (entries.length === 0) {
    html += `<div style="padding:4px;color:#888">  (empty directory)</div>`;
  }

  const itemCount = fsData.dirs.length + fsData.files.length;
  html += `<div class="fm-statusline">${itemCount} item${itemCount !== 1 ? 's' : ''} â”‚ H: toggle hidden â”‚ Backspace: parent</div>`;

  container.innerHTML = html;

  // Update title
  win.querySelector('.win-title').textContent = `File Manager - ${basename} (${itemCount} items)`;

  // Store entries for keyboard navigation
  win._fmEntries = entries;

  // Click handlers for entries
  container.querySelectorAll('.fm-entry').forEach(el => {
    el.addEventListener('click', () => {
      const idx = parseInt(el.dataset.idx);
      const type = el.dataset.type;
      const entryPath = el.dataset.path;

      win.dataset.fmSelected = '0';

      if (type === 'dir') {
        win.dataset.fmPath = entryPath;
        renderFileManager(win);
      } else {
        // Open file in Notepad viewer
        const entry = entries[idx];
        if (entry && entry.content !== null) {
          openFileViewer(entry.name, entry.content);
        } else if (entry) {
          showDialog('Binary File', `${entry.name}\n\nThis appears to be a binary file\nand cannot be displayed as text.`, ['OK']);
        }
      }
    });
  });
}

function openFileViewer(filename, content) {
  const offset = windows.length * 20;
  createWindow(`Notepad - ${filename}`,
    content,
    150 + offset, 60 + offset, 380);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Actions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doAction(action) {
  const offset = windows.length * 20;

  switch(action) {
    case 'filemanager':
      createFileManager('/home/user');
      break;

    case 'notepad':
      createWindow('Notepad - Untitled',
        `Welcome to RetroTUI Notepad\n\n` +
        `This is a placeholder for a full\n` +
        `text editor implementation.\n\n` +
        `Future features:\n` +
        `  - Text editing with cursor\n` +
        `  - File open/save dialogs\n` +
        `  - Search and replace\n` +
        `  - Word wrap toggle`,
        150 + offset, 60 + offset, 340);
      break;

    case 'terminal':
      createWindow('Terminal',
        `user@retrotui:~$ _\n\n` +
        `(Terminal emulation placeholder)\n` +
        `Future: embedded terminal via PTY`,
        130 + offset, 70 + offset, 420);
      break;

    case 'settings':
      createWindow('Settings',
        `â•”â• Display Settings â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n` +
        `â•‘                                       â•‘\n` +
        `â•‘  Theme:  (â—) Windows 3.1              â•‘\n` +
        `â•‘          ( ) DOS / CGA                â•‘\n` +
        `â•‘          ( ) Windows 95               â•‘\n` +
        `â•‘                                       â•‘\n` +
        `â•‘  Desktop Pattern: â–‘ â–’ â–“               â•‘\n` +
        `â•‘                                       â•‘\n` +
        `â•‘  Colors: 256-color mode               â•‘\n` +
        `â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`,
        160 + offset, 55 + offset, 360);
      break;

    case 'about':
      showDialog('About RetroTUI',
        `<b>RetroTUI v0.2.2</b>\n\n` +
        `A retro desktop environment\n` +
        `for the Linux console.\n\n` +
        `<b>v0.2.2 - Bugfixes</b>\n` +
        `- Directory navigation\n` +
        `- File viewer (Notepad)\n` +
        `- Click or keyboard browse\n\n` +
        `- No X11 required\n` +
        `- Mouse via GPM/xterm\n` +
        `- Python 3 + curses\n` +
        `- Zero external dependencies`,
        ['OK']);
      break;

    case 'help':
      showDialog('Keyboard & Mouse Help',
        `<b>General:</b>\n` +
        `Tab         Cycle windows\n` +
        `Escape      Close menu/dialog\n` +
        `Ctrl+Q      Exit\n` +
        `F10         Open menu\n\n` +
        `<b>File Manager:</b>\n` +
        `â†‘/â†“         Move selection\n` +
        `Enter       Open dir/file\n` +
        `Backspace   Parent directory\n` +
        `H           Toggle hidden files\n` +
        `PgUp/PgDn   Page scroll\n\n` +
        `<b>Mouse:</b>\n` +
        `Click       Select/activate\n` +
        `Drag title  Move window\n` +
        `Dbl-click   Open icon\n` +
        `Scroll      Scroll content`,
        ['OK']);
      break;

    case 'new':
      createWindow(`Window ${winIdCounter}`,
        `New empty window\n\nCreated at ${new Date().toLocaleTimeString()}`,
        120 + offset, 45 + offset, 300);
      break;

    case 'exit':
      showDialog('Exit RetroTUI',
        'Are you sure you want to exit?\n\nAll windows will be closed.',
        ['Yes', 'No'],
        (btn) => {
          if (btn === 'Yes') {
            windows.forEach(w => w.remove());
            windows = [];
            updateWinCount();
          }
        });
      break;
  }
}

// Dialog
function showDialog(title, body, buttons, callback) {
  const overlay = document.getElementById('dialog-overlay');
  document.getElementById('dlg-title').textContent = title;
  document.getElementById('dlg-body').innerHTML = body.replace(/\n/g, '<br>');

  const btnContainer = document.getElementById('dlg-buttons');
  btnContainer.innerHTML = '';
  buttons.forEach((label, i) => {
    const btn = document.createElement('button');
    btn.className = 'btn' + (i === 0 ? ' primary' : '');
    btn.textContent = label;
    btn.addEventListener('click', () => {
      overlay.classList.remove('show');
      if (callback) callback(label);
    });
    btnContainer.appendChild(btn);
  });

  overlay.classList.add('show');
}

document.getElementById('dialog-overlay').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) {
    e.currentTarget.classList.remove('show');
  }
});

// Create initial welcome window
createWindow('Welcome to RetroTUI',
  `â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n` +
  `â•‘     Welcome to RetroTUI v0.2.2      â•‘\n` +
  `â•‘                                     â•‘\n` +
  `â•‘  A Windows 3.1 style desktop        â•‘\n` +
  `â•‘  for the Linux console.             â•‘\n` +
  `â•‘                                     â•‘\n` +
  `â•‘  âœ¨ NEW in v0.2.2:                  â•‘\n` +
  `â•‘  â€¢ File Manager with navigation     â•‘\n` +
  `â•‘  â€¢ Click folders to browse          â•‘\n` +
  `â•‘  â€¢ Open text files in Notepad       â•‘\n` +
  `â•‘  â€¢ Keyboard: â†‘â†“ Enter Backspace     â•‘\n` +
  `â•‘                                     â•‘\n` +
  `â•‘  Double-click icons to open apps.   â•‘\n` +
  `â•‘  Drag title bars to move windows.   â•‘\n` +
  `â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`,
  200, 80, 400);
</script>
</body>
</html>
